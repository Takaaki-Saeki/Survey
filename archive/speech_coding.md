# 「音声符号化技術について」まとめ

###### tags: `LAB`

## 1. 導入
音声符号化とは，情報の損失を最小限にしながら，音声波形を離散化された値に変換することです．音声は冗長性のある信号であり，音声符号化はその冗長性を利用し，ある正確さで復元できるように情報を最小限にします．
ここで音声符号化技術には大きく分けて波形符号化・ボコーダの2種類があります．波形符号化は，音声固有のモデル化を行うことなく，音声波形を可能な限り信頼性を持って復元することを目的として符号化する方法です．ボコーダは，人間の声のモデルを元に信号を分析し，パラメータ化して符号化を行う方式で，元の音声波形を忠実に復元することを目的としていない方法です．
波形符号化では，ビットレートが十分に高ければ高品質な音声を生成することができます．ボコーダは非常に低いビットレートでも明瞭な音声を生成できますが，自然さ・異なる話者間での均一性という点での音声品質は低いです．この本が書かれた当時，ボコーダの実応用は，特にビットレートが低い通信経路でのコミュニケーションに限られていました．今回，主に取り上げるのは，デジタル通信経路での音声コミュニケーションに適切な，$4-64kb/s$の範囲のビットレートでの波形符号化です．
この章では，波形符号化のビットレートを減らすのに役立つと考えられてきた様々な技術に関する議論とともに，波形符号化の基礎原理について見ていきます．さらに，様々なビットレートで符号化された音声の主観的な品質に関する議論とともに結論を述べます．

## 2. 音声符号化の基礎概念
デジタル通信の情報レートは$kb/s$(一秒あたりに伝送されるビット数)で表現されます．アナログ信号からデジタル信号への変換には，サンプリングと量子化という2段階のステップがあります．サンプリングとは，時間に関する連続関数を，一定の時間間隔をもつ離散的な系列に変換することです．また量子化とは，連続的な振幅を離散的な値に変換することです．以下，サンプリング・量子化のそれぞれについて見ていきます．

### 2.1 サンプリング
Tをサンプリング周期とします．連続的な時系列信号$s(t)$を$nT$時間でサンプリングすると，離散的にサンプリングされた点$s(nT)$の系列となります．この時，サンプリング周波数(サンプリングレート)$f_{s}$はサンプリング周期Tによって決まります．サンプリングを行う上で最も重要な事実がサンプリング定理です．サンプリング定理によると，アナログ信号$s(t)$が最高周波数$B$によって帯域制限されている時，サンプリング周波数を$2B$以上でサンプリングすれば，元のアナログ信号を完全に復元できます．
これは図のように，サンプリングによって得られたデルタ関数列を離散時間フーリエ変換し，元のアナログ信号のスペクトルを取り出すことを考えると分かります．もしサンプリング周波数が$2B$以上であれば，各々のデルタ関数を離散時間フーリエ変換して得られたスペクトル同士は，互いに重なり合うことがなく，窓関数をかけることによって元のアナログ信号のスペクトルを取り出すことができます．反対にサンプリング周波数が$2B$より小さければ，スペクトル同士が互いに重なり合い，元のアナログ信号のスペクトルを完全に復元することができません．
![](https://i.imgur.com/7EW2fBj.png)


### 2.2 量子化
量子化とは，アナログ波形の振幅を，与えられた離散値によって近似的に表現することです．量子化のプロセスでは，常に信号内にエラー，すなわち量子化ノイズが生じます．量子化の性能を測る上で，ノイズのパワーに対する信号のパワー，すなわちSignal-to-Noise Ratio(SNR)が頻繁に用いられます．

#### スカラ量子化とベクトル量子化
連続信号の各サンプルを別々に量子化することをスカラ量子化と言います．このとき，通常は各サンプルに対して最も近い離散値に置き換えることで量子化が行われます．
それに対し，連続信号のサンプルのブロックをまとめて量子化することをベクトル量子化といいます．ベクトル量子化の手順の一例は次のようになります．
まずサンプルをN個ずつ取り込み，N次元のベクトルとします．全てのサンプルを取り込んだら，次に符号化する数K個の各ベクトルに対してクラスタリングを行います．その後，各クラスタから一つずつ「代表ベクトル」を決め，代表ベクトル以外のベクトルは割り当てられたクラスタの代表ベクトルに置き換えます．最後に代表ベクトルを符号化することで量子化を完了します．この方法はベクトルの次元を増やすことにより通常より少ない符号長での量子化が期待できますが，次元が増えると最適なクラスタリングと代表ベクトルの選出に関する計算量が増大します．この解決のために様々な手法が提案されています．
ベクトル量子化では，同じ量子化ビットで量子化した場合，スカラ量子化よりもエラーが小さくなります．

#### 一様量子化
量子化幅を一定として量子化を行う方式を一様量子化といいます．ステップサイズ$\Delta$で量子化する場合，量子化誤差は$-\Delta/2$から$\Delta/2$の範囲に一様に分布し，パワーは$\Delta^2/12$に等しくなります．$-x_{\mathrm{max}}$から$x_{\mathrm{max}}$の範囲の信号をnビットで量子化する場合，ステップサイズ$\Delta$は$\Delta = 2x_{\mathrm{max}}/2^n$，量子化平均二乗誤差は以下のように表されます．
![](https://i.imgur.com/xJXvJdL.png)
ノイズパワーに対する信号パワーは以下の式のように記述されます．これは，ビット数を1増やすと6dBだけSNRが増加することを表しています．
![](https://i.imgur.com/7Jv8jDs.png)


#### 非一様量子化
一様量子化では，信号の強さとは無関係に一定のノイズが乗ってしまいます(下図)．音声信号のパワーは広い範囲で変化するので，信号のパワーが低いところではSNRが低くなってしまうという欠点があります．量子化間隔を一様ではなく，信号の値によって非一様に増減させる方式を非一様量子化といいます．非一様量子化は，一様量子化されたアナログ信号をμ-lawアルゴリズムなどによって圧縮・伸張させることと等価です．
![](https://i.imgur.com/cV0hH1A.png)

## 3.　量子化効率の良い波形符号化

### 3.1 圧伸パルス符号変調
重要な圧縮則として，以下に示すμ-law量子化が挙げられます．

ここで，xは入力信号の振幅であり，$x_{\mathrm{max}}$は最大振幅，μは圧縮の度合いを制御するパラメータです．μの値としては100-200がよく用いられます．
μ-law圧縮を用いた場合の音声信号のパワーレベルと量子化ノイズの例を下図に示します．μ-law PCMでは，入力信号の振幅が小さいほどノイズのパワーは小さくなる．
![](https://i.imgur.com/4sbRVNW.png)

### 3.2 適応差分パルス符号変調
一般に，音声波形の隣接したサンプルは相関が高いという性質があります．差分PCM(DPCM)は，前に量子化されたサンプルに基づき，信号と予測された値の差分を量子化することにより，隣接したサンプル同士の相関性に対して高い性能を発揮します．信号の差分のダイナミックレンジはたいてい入力信号のダイナミックレンジよりも遥かに小さいため，より小さな量子化ビットで同じ量子化誤差にすることができます．適応差分PCM(ADPCM)では，差分信号は量子化ステップサイズの適応制御によって量子化されます．ADPCMとμ-law PCMのビットごとのSNR比較を下図に示します．ここで，ADPCMは8dBのSNR増加を示していますが，4dBは差分符号化による増加，4dBは量子化適応による増加です．
![](https://i.imgur.com/mnjWeJl.png)


## 4. 予測符号化
線形予測符号化はサンプル間の相関を利用し，過去に量子化された値から現在のサンプル値を予測し，符号化された音声信号のビットレートを減少させます．音声サンプルと予測値との差分のダイナミックレンジは，一般的に入力信号のダイナミックレンジよりも遥かに小さいので，より少ないビット数で符号化を行うことが可能です．

### 4.1 予測符号化装置
下図のダイアグラムは予測符号化装置の原理を示しています．音声信号$s(t)$がサンプリングされると，予測器は，送信器にある量子化された音声信号の過去のサンプルから信号の現在の値$\hat{s_{n}}$を推定します．予測値$\hat{s_{n}}$は，差分$\delta_{n}$を形成するために信号の値$s_{n}$から差し引かれ，差分$\delta_{n}$は量子化され，符号化され，受信機に送られます．送信された信号は送信機でデコードされ，送信機で使われたものと同じ予測器で，次の音声サンプルを予測するのに用いられます．受信器では，送られた信号はデコードされ，ローパスフィルタをかけられてデコードされた音声信号のサンプル信号の予測値に付加されます．
予測符号化装置では，元の信号とデコードされた信号の誤差$e_{n}=\hat{s_{n}}-s_{n}$は，量子化器，エンコーダー，デコーダーで導入された$\delta_{n}^{\prime}-\delta_{n}$と全く同じです．そのため，デコードされた音声信号のSNRは，デコードされた差分信号のSNRを，入力信号の二乗平均の差分信号の二乗平均に対する比に等しい因子の分だけ上回ります．予測符号化を用いることにより，全く同じ量子化をしてPCMに対してSNRおよそ20dB上回ることが期待されます．
![](https://i.imgur.com/73KcRdG.png)

### 4.2 音声信号の線形予測分析
線形予測は，信号の冗長性を取り除く方法としてよく知られています．予測器Pは2つの異なる予測器を含んでおり，一つはスペクトル包絡に基づくものであり，もう一つは準周期性を持つ音源振動に基づくものです．スペクトル包絡に基づく予測器は，z変換の記法で以下のように表すことができます．
![](https://i.imgur.com/k5pi3LQ.png)
ただし，$a_{k}$は予測器の係数です．pの値は過去のサンプルの個数であり，サンプリングレート8kHzの場合は10程度とすることが多いです．また，準周期性を持つ音源振動に基づく予測器は，以下のように表せます．
![](https://i.imgur.com/Lyvh0gv.png)
ただし，Mは周期，$\beta$は周期の次数を表しています．
予測器の係数$a_{k}$は，平均二乗予測誤差を最小化することによって得られる線型方程式を解くことによって決定されます．第一の予測器については，この線型方程式は以下の式のように書けます．
![](https://i.imgur.com/KtXGMhm.png)
ただし，$c_{i}$は，音声信号の短時間の自己相関係数です．

### 4.3 量子化ノイズのスペクトル
従来の波形符号化では，元の音声波形と符号化された音声波形のRMSEを最小化しようとしていました．その後，信号のひずみの主観的な知覚は，RMSEだけでなく，量子化誤差と音声のスペクトルに依存すると考えられるようになりました．
量子化誤差のスペクトルを柔軟に制御するの一つの方法は，従来の予測分析に，下図のようにprefilterとpostfilterを与えることです．
![](https://i.imgur.com/Ch3E8fJ.png)
理想的には，フィルタ1-Rは知覚される歪むを最小化するように調整しますが，，実際には以下のように与えられます．
![](https://i.imgur.com/RO4pUb5.png)

ただし，$\alpha$はノイズのスペクトルの形状を操作するパラメータです．典型的には，8kHzのサンプリング周波数で$\alpha=0.80$が選ばれます．符号化器で知覚されるノイズの大部分は，信号の小さい周波数領域から来ます．そこで，ノイズスペクトルの形状を調整することにより，信号の小さい領域から信号の大きい領域へノイズを移動させることができます．聴覚マスキングの理論から，フォルマント領域の量子化ノイズが部分的にあるいは完全に音声信号によってマスキングされます．対応する音声信号のスペクトルとともに，量子化ノイズのスペクトルの例を下図に示します．細かい量子化を行なった場合ではありますが，上図に示すような一般の予測分析器は，フィルタRを適切に選択することにより，量子化ノイズのスペクトルの望ましい形状を生成することが可能であり，荒い量子化を行なった場合はそうではありません．これは，量子化を行なった場合の予測符号化器の主要な欠点の一つですが，ベクトル量子化によってある程度回避することが可能です．
![](https://i.imgur.com/oUNZ9BV.png)

## 5.符号励振線形予測
符号励振線形予測(CELP)では，サンプルブロックをまとめた量子化が，下図の量子化器をコードブックに置き換え，ブロック全体での平均エラーが最小になるようにコードブックから選択することによって得られます．
下図のブロック線図は，最適なコードワードを選択する手順を示しています．それぞれのコードワードは振幅でスケーリングされ，予測フィルタを通してフィルタリングされるます．またこの場合も，スペクトル包絡に基づく予測器と，音源振動に基づく予測器の2種類の予測器が入っています．結果として得られる音声信号は，元の信号と比較され，エラー信号を形成します．このエラー信号は，二乗され，平均されることにより，知覚エラーを推定するような重み付けフィルタを通ります．これにより，知覚エラーを最小にするコードワードが量子化器のoutputとして生成されます．
重み付けフィルタの目的は，エラーが聴覚的に重要でない周波数を低減させ，エラーが聴覚的に重要になるような周波数を増幅させることにより，主観的に意味のあるエラー尺度を与えることである．知覚フィルタの伝達関数は，線形予測装置の予測器で用いられたprefilterの伝達関数と同じです．
コードブックを探索するのに必要な時間を最小限にするため，効率的な探索手順が開発されています．$4.8kb/s$の音声符号化で用いられる連邦の標準は，スパースで重複があり，三つ組みの擬似乱数のコードワードをもつものと，適応的なコードブックを並列に用いるコードブックでした．適応的なコードブックは，準周期性を持つ音源信号に基づく予測器と同じ関数で表されます．その場合，予測器はスペクトル包絡に基づく予測器のみを含みます．北アメリカでのデジタルcellular通信の標準は，適応コードブックと，重複した二進数のコードワードを含む二つのコードブックを用いています．この時，それぞれのコードブックから，探索時間を最小にするように最適なコードワードが選択されます．CELPコーディングは，最も重要な符号化技術の一つであり，$4-16kb/s$で高音質な符号化を行うことができます．
![](https://i.imgur.com/eUyNYao.png)


## 6 符号化された音声の主観的な音質について
音声符号化は，常に音声信号の歪みを生む．このひずみの大きさは，音声品質の主観的評価により決定することが重要です．音声品質の客観的指標にはいくつかの歪みを測るための指標がありますが，最終的な評価は音声品質の適切な主観評価によってのみ行われます．

### 6.1 主観的な評価手法
主観評価にはいくつかの手法がありますが，最も一般的なものはMean Opinion Scoreです．このテストはよくMOSテストと呼ばれますが，聴者は選択肢(例えば，Unsatisfactory, Poor, Fair, Good, Excellentの5つなど)を選ぶように求められ，テストデータの音声品質を評価します．それぞれのカテゴリには1-5の数字がつけられ，MOSスコアはこれらを平均することによって算出されます．

### 6.2 ビット数を変化させた場合の音質
下図は，ビット数を変化させた時の，当時の音声品質を表したものです．この図は，当時の符号化器の性能を端的に表していると言えます．多くの音声符号化の標準は，デジタルな音声通信を支えるために確立されました．MOSが4より大きい最高品質の音声は，ビットレート$16kb/s$より大きいところでのみ得られ，電話網への応用に適しています．MOSがおよそ4で，ビットレートが$8kb/s$あたりの音声品質は，携帯電話やボイスメールへの応用には十分だと言えます．$4.8kb/s$あたりか，それ以下で動作する音声符号化は，中程度(つまりMOS3あたり)の音声品質しか提供できません． この場合は，公共の通信網を用いて，匿名化された音声を送受信するという特殊なケースにしか適用できません．
![](https://i.imgur.com/zEUWleq.png)











